---
title: SSL 인증서 적용기
author: cheonkyu
date: 2021-06-11 22:10:00 -0500
categories: [SSL, Docker]
tags: [Apache, Certbot, Chrome]
---

# SSL 인증서 적용기

## SSL

SSL에 관해 잘 정리된 글이다.

[안전한 SSL/TLS를 운영하기 위해 알아야 하는 것들](https://engineering.linecorp.com/ko/blog/best-practices-to-secure-your-ssl-tls/)

## SSL 인증서 발급 with AWS Route53

certbot에 Route53 플러그인을 설치해 보다 간편하게 설정할 수 있었다. 

docker 이미지를 이용했다.

```
$ sudo docker run -it --rm --name certbot \
            -v "/etc/letsencrypt:/etc/letsencrypt" \
            -v "/var/lib/letsencrypt:/var/lib/letsencrypt" \
            certbot/certbot certonly --email youremail@email.com
	 -d yourdomain.com -d *.yourdomain.com 
```

`certbot으로는 와일드카드 인증서를 가급적 받지 말자.`

와일드카드 인증서는 여러 서브도메인을 하나의 인증서로 관리할 수 있다.

하지만 인증서 갱신하는데 불편함이 있다. 3개월 마다 갱신해줘야하는데 

그때마다 DNS TXT 값을 수동으로 변경해주어야 한다.


[Dockerhub certbot/dns-route53](https://hub.docker.com/r/certbot/dns-route53)

[certbot-dns-route53.readthedocs.io](https://certbot-dns-route53.readthedocs.io/en/stable/)


## 아파치 설정

기존 서버가 아파치 그냥 설치되어있었다. 

추후 유지보수를 위해 Dockerize 작업을 해주었다. 

모듈을 설치하지 않으면 특정 설정을 읽지를 못한다. proxy_http, ssl, rewrite 모듈을 설치해준다.

httpd 공식이미지를 쓰고 싶었다. 하지만 현 서버와 디렉토리 구조나 설정 파일이 미묘하게 달랐기에 최대한 기존 환경과 비슷한 이미지를 선택했다.

### Dockerfile

```
FROM ubuntu/apache2:2.4-20.04_beta
USER root

# 프록시
RUN ["a2enmod", "proxy_http"]

# SSL
RUN ["a2enmod", "ssl"]

# 리다이렉트
RUN ["a2enmod", "rewrite"]
```

### docker-compose.yml

```
container_name: web
    build:
      context: ./web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./sites-enabled:/etc/apache2/sites-enabled
      - /etc/letsencrypt:/etc/letsencrypt
      - /etc/localtime:/etc/localtime:ro
```

## Virtual host

하나의 서버에 여러 도메인 주소를 매핑 시키고 싶을때 이용한다.

![2022-06-11-SSL인증서적용기-apache-virtualhost](/assets/img/posts/2022-06-11-SSL%EC%9D%B8%EC%A6%9D%EC%84%9C%EC%A0%81%EC%9A%A9%EA%B8%B0-apache-virtualhost.png)

[아파치 공식 홈페이지 vhosts](https://httpd.apache.org/docs/2.4/ko/vhosts/examples.html)

## HTTP -> HTTPS 리다이렉트 상태코드 308 지정

ProxyPass로 api 쪽으로 리다이렉트를 할때는 상태코드를 308로 지정해줘야했다.

REST API 메소드(GET, POST, PUT 등)이 모두 GET으로 리다이렉트된다.

```
<VirtualHost *:80>
	ServerName yourdomain.com

    RewriteEngine On
	RewriteCond %{HTTPS} !on
	RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [L,R=308]
</VirtualHost>
```

![리다이렉트 흐름](https://developer.mozilla.org/en-US/docs/Web/HTTP/Redirections/httpredirect.png)

리다이렉트는 크게 세가지 종류가 있다.

1. Permanent redirections
2. Temporary redirections
3. Special redirections

## Chrome https 

HTTP-> HTTPS 리다이렉트 후 사전에 파악하지 못한 현상이 나와 바로 롤백을 했다.

백업해놓은 설정파일로 전환 했음에도 리다이렉트가 되는 현상이 있었다. 

크롬브라우저에서만 HTTPS로 리다이렉트가 되고 있었다.

크롬 자체 보안 설정 때문이었다.

브라우저와 SSL 연관점이 있을거라고는 나중에 알게 되었다. (왜 리다이렉트되는지 고뇌를 많이 했다.)

[stop-chrome-from-automatically-redirecting-https](https://howchoo.com/chrome/stop-chrome-from-automatically-redirecting-https)




